    <!doctype html>
    <html class="no-js" lang="en">
      <head>
        <meta charset="utf-8">
        <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
        <title>Points in box</title>

        <link href="./stylesheets/example.css" media="screen" rel="stylesheet" type="text/css" />


        <link rel="shortcut icon" href="/images/favicon.ico" />
        <noscript><meta http-equiv="refresh" content="0;url=/no_javascript.html"></noscript>

            <!-- Find box coordinates javascript -->
            <script type ="text/javascript" src="http://www.movable-type.co.uk/scripts/latlon.js"></script>

            <!-- Type label text javascript -->     
            <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
          <script type="text/javascript" src="./js/label.js"></script>

            <!-- Visulization javascript -->
            <script type="text/javascript" src="http://www.google.com/jsapi"></script>

            <!-- Initialize visualization -->
            <script type="text/javascript">
              google.load('visualization', '1', {});
            </script>

      </head>
      <body class="developers examples examples_downloads examples_downloads_points-in-box examples_downloads_points-in-box_index">

            <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

    <script type="text/javascript">

        var store_table = 4121905;

        //send a call to GViz to retrieve lat/long coordinates of the stores
        function getStoreData() {
          //set the query using the input from the user

            var queryText = encodeURIComponent("SELECT Latitude,Longitude,Impressions FROM " + store_table);
          var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq='  + queryText);

          //set the callback function
          query.send(doLoop);

        }

        function drawBox(topleftx, toplefty, bottomrightx, bottomrighty) {

          var bounds = new google.maps.LatLngBounds(
            new google.maps.LatLng( topleftx, toplefty ),
            new google.maps.LatLng( bottomrightx, bottomrighty )
          );

        var overlay = new google.maps.Rectangle({
          map: carto_map,
          bounds: bounds,
          strokeColor: "#0000ff",
          strokeOpacity: 0.20,
          strokeWeight: 2,
          fillColor: "#0000ff",
          fillOpacity: 0.050,
        });
        }

        function doLoop(response) {
            numRows = response.getDataTable().getNumberOfRows();

        //Basic
           var cartodbMapOptions = {
             zoom: 7,
                     center: new google.maps.LatLng( 37.926868, -121.68457 ),
             // center: new google.maps.LatLng( 40.7248057566452, -74.003 ),
             // disableDefaultUI: true,
             mapTypeId: google.maps.MapTypeId.ROADMAP
           }

            // Init the map
            carto_map = new google.maps.Map(document.getElementById("map"),cartodbMapOptions);

            for(i = 0; i < numRows; i++) {

                var centerX = response.getDataTable().getValue(i,0);
                var centerY = response.getDataTable().getValue(i,1);
                var imps = response.getDataTable().getValue(i,2);

                var centerPoint = new LatLon(centerX,centerY);
                var latLng = new google.maps.LatLng(centerX,centerY);

                var toplefty = centerPoint.destinationPoint(-45, 6)._lon;
                var topleftx = centerPoint.destinationPoint(-45, 7.7)._lat;

                var bottomrighty = centerPoint.destinationPoint(135, 6)._lon;       
                var bottomrightx = centerPoint.destinationPoint(135, 7.7)._lat;     

                drawBox(topleftx, toplefty, bottomrightx, bottomrighty);     

         var marker = new google.maps.Marker({
           position: latLng,
           draggable: false,
                 markertext: imps,
                 flat: true,
           map: carto_map
         });

           var label = new Label({
             map: carto_map,
                 position: latLng,
                 draggable: true
           });
           label.bindTo('text', marker, 'markertext');
             marker.setMap(null);

            }

        }

        $(function() {
                        getStoreData();
             });

          </script>

                <div id="map"></div>
      </body>
    </html>


